<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Alankar Events | Premium Collection</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;1,400&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { 
            --gold: #d4af37; 
            --bg-black: #070606; 
            --white: #ffffff; 
        }

        /* Global */
        html,body { height:100%; }
        body { 
            font-family: 'Poppins', sans-serif; 
            margin: 0; 
            background: var(--bg-black);
            color: var(--white); 
            overflow-x: hidden;
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
        }

        header { padding: 56px 16px 20px; text-align: center; position:relative; z-index:2; }
        header h1 { 
            font-family: 'Playfair Display', serif; 
            font-size: clamp(2.2rem, 10vw, 4rem); 
            margin: 0; 
            letter-spacing: 8px; 
            text-transform: uppercase;
            background: linear-gradient(90deg, rgba(138,109,26,1), #fff9e6 40%, rgba(138,109,26,1));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 4px 10px rgba(0,0,0,0.6);
        }
        header p { color: var(--gold); text-transform: uppercase; letter-spacing: 6px; font-size: 0.75rem; margin-top: 12px; opacity:0.95; }

        #gallery { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
            gap: 20px; 
            padding: 20px; 
            max-width: 1200px; 
            margin: 0 auto 20px auto; 
            position:relative;
            z-index:2;
        }

        /* Card (lightweight but luxurious) */
        .item-card { 
            position: relative; 
            overflow: hidden; 
            cursor: pointer; 
            background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.01));
            border-radius: 12px; 
            border: 1px solid rgba(212,175,55,0.06);
            box-shadow: 0 6px 18px rgba(0,0,0,0.45);
            transition: transform 220ms ease, box-shadow 220ms ease;
            transform-origin: center;
            will-change: transform;
        }

        .item-card:hover { 
            transform: translateY(-6px);
            box-shadow: 0 14px 36px rgba(0,0,0,0.55);
        }

        .img-wrapper { 
            overflow: hidden; 
            width: 100%; 
            aspect-ratio: 1/1.2; 
            position:relative;
            background: #090909;
        }

        .item-card img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            transition: transform 360ms ease, filter 280ms ease; 
            display: block;
            will-change: transform, opacity;
            transform-origin: center;
        }

        .item-card:hover img {
            transform: scale(1.03);
            filter: contrast(1.02);
        }

        .price-tag { 
            position: absolute; 
            bottom: 10px; 
            left: 10px; 
            right: 10px;
            background: linear-gradient(90deg, rgba(212,175,55,0.95), rgba(255,241,184,0.92));
            padding: 8px 12px; 
            font-weight: 700; 
            font-size: 0.9rem; 
            letter-spacing: 1px; 
            color: black;
            text-align: center;
            border-radius: 10px;
            pointer-events: none;
        }

        .category-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 98;
            background: rgba(0,0,0,0.45);
            color: var(--gold);
            padding: 6px 10px;
            font-size: 11px;
            border-radius: 999px;
            letter-spacing: 0.6px;
            text-transform: uppercase;
            pointer-events: none;
            border: 1px solid rgba(212,175,55,0.08);
        }

        .del-btn { 
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 99;
            background: #ff5252;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 10px;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
        }

        /* modal simplified */
        #photoModal { 
            display: none; 
            position: fixed; 
            inset: 0; 
            z-index: 9999; 
            align-items: center; 
            justify-content: center; 
            background: rgba(0,0,0,0.85);
        }
        #photoModal.active { display: flex; }
        .modal-container { position: relative; max-width: 90%; text-align: center; }
        .modal-content { max-height: 80vh; max-width: 100%; border-radius: 12px; border: 1px solid rgba(212,175,55,0.08); display:block; margin:0 auto; box-shadow: 0 30px 60px rgba(0,0,0,0.6); }
        .modal-loader { color: var(--gold); padding: 12px 0; display:none; }

        .wa-btn { 
            display: inline-block; 
            margin-top: 12px; 
            background: linear-gradient(90deg, rgba(212,175,55,1), rgba(255,241,184,0.95)); 
            color: black; 
            padding: 10px 20px; 
            text-decoration: none; 
            border-radius: 999px; 
            font-weight: 700; 
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 1.6px;
        }

        /* admin panel simplified */
        #adminPanel { display: none; background: linear-gradient(180deg,#060606,#0b0b0b); padding: 48px 16px; border-top: 1px solid rgba(212,175,55,0.04); }
        .admin-card { max-width: 420px; margin: 0 auto; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding: 18px; border-radius: 10px; border: 1px solid rgba(212,175,55,0.06); }
        input, select, .btn-post { width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 6px; border: 1px solid #333; background: #111; color: white; }
        .btn-post { background: linear-gradient(90deg,#d4af37,#f5e2a6); color: black; border: none; font-weight: 700; cursor: pointer; }

        footer { padding: 40px 16px; text-align: center; opacity: 0.8; font-size: 10px; letter-spacing: 5px; color: var(--gold); position:relative; z-index:2; }

        /* Load more */
        #loadMoreWrap { text-align:center; margin-bottom: 40px; }
        #loadMore { background: transparent; border: 1px solid rgba(212,175,55,0.15); color: var(--gold); padding: 10px 20px; border-radius: 999px; cursor:pointer; }
    </style>
</head>
<body>

    <header>
        <h1>ALANKAR EVENTS</h1>
        <p>A Legacy of Luxury</p>
    </header>

    <div id="gallery" aria-live="polite"></div>
    <div id="loadMoreWrap"><button id="loadMore">Load more</button></div>

    <div id="photoModal" role="dialog" aria-modal="true" aria-hidden="true">
        <div class="modal-container">
            <span id="modalClose" onclick="closeModal()" style="position:absolute; top:-48px; right:0; color:var(--gold); font-size:36px; cursor:pointer;">&times;</span>
            <div class="modal-loader" id="modalLoader">Loading…</div>
            <img class="modal-content" id="modalImg" alt="Enlarged photo">
            <br>
            <a id="waLink" href="#" target="_blank" class="wa-btn">Inquire on WhatsApp</a>
        </div>
    </div>

    <div id="adminPanel">
        <div class="admin-card">
            <h2 style="text-align:center; color:var(--gold)">Admin Studio</h2>
            <input type="file" id="photoInput" accept="image/*">
            <input type="text" id="priceInput" placeholder="Price (e.g. ₹80,000)">
            <select id="categorySelect" title="Select category">
                <option value="Marriage" selected>Marriage</option>
                <option value="Birthday">Birthday</option>
                <option value="Babyshower">Babyshower</option>
                <option value="Other">Other</option>
            </select>
            <button class="btn-post" onclick="handleUpload()">Post to Gallery</button>
            <p id="status" style="font-size:12px; color:var(--gold); text-align:center;"></p>
        </div>
    </div>

    <footer onclick="secretClick()">© ALANKAR EVENTS</footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, getDocs, limit, startAfter, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDCBOg_FlIpVZyBYVW6yFUcgU7gwIUD1Ks",
            authDomain: "alankar-luxe.firebaseapp.com",
            projectId: "alankar-luxe",
            messagingSenderId: "1093775711292",
            appId: "1:1093775711292:web:30ffd3741a16c10ce9b739"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Perf-tuned constants
        const PAGE_SIZE = 12;
        const THUMB_TARGET_KB = 18;    // small thumbnail for gallery
        const THUMB_MAX_WIDTH = 420;
        const FULL_TARGET_KB = 50;     // full image for modal
        const FULL_MAX_WIDTH = 700;
        const MIN_QUALITY = 0.45;

        let isAdmin = false;
        let clickCount = 0;
        let lastVisible = null;
        const idle = window.requestIdleCallback ? window.requestIdleCallback.bind(window) : (cb) => setTimeout(cb, 500);

        // Secret admin toggle
        window.secretClick = () => {
            clickCount++;
            if (clickCount === 5) {
                const pass = prompt("Key:");
                if (pass === "alankar777") {
                    isAdmin = true;
                    document.getElementById('adminPanel').style.display = 'block';
                    document.getElementById('adminPanel').scrollIntoView({behavior: 'smooth'});
                    // refresh current view
                    resetAndLoad();
                }
                clickCount = 0;
            }
            setTimeout(() => { clickCount = 0; }, 3000);
        };

        // Helpers
        function dataUrlSizeKB(dataUrl) {
            if (!dataUrl) return 0;
            const comma = dataUrl.indexOf(',');
            const b64 = dataUrl.slice(comma + 1);
            const padding = (b64.endsWith('==') ? 2 : b64.endsWith('=') ? 1 : 0);
            const bytes = (b64.length * 3) / 4 - padding;
            return bytes / 1024;
        }

        function compressDataUrlToTarget(dataUrl, targetKB = FULL_TARGET_KB, maxWidth = FULL_MAX_WIDTH) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.src = dataUrl;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const scale = Math.min(1, maxWidth / img.width);
                    canvas.width = Math.round(img.width * scale);
                    canvas.height = Math.round(img.height * scale);
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    let quality = 0.92;
                    const tryExport = () => {
                        const out = canvas.toDataURL('image/jpeg', quality);
                        if (dataUrlSizeKB(out) <= targetKB || quality <= MIN_QUALITY) {
                            resolve(out);
                        } else {
                            quality -= 0.06;
                            if (quality < MIN_QUALITY) quality = MIN_QUALITY;
                            setTimeout(tryExport, 0);
                        }
                    };
                    tryExport();
                };
                img.onerror = reject;
            });
        }

        function compressFileToTarget(file, targetKB = FULL_TARGET_KB, maxWidth = FULL_MAX_WIDTH) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const scale = Math.min(1, maxWidth / img.width);
                        canvas.width = Math.round(img.width * scale);
                        canvas.height = Math.round(img.height * scale);
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        let quality = 0.92;
                        const tryExport = () => {
                            const dataUrl = canvas.toDataURL('image/jpeg', quality);
                            if (dataUrlSizeKB(dataUrl) <= targetKB || quality <= MIN_QUALITY) {
                                resolve(dataUrl);
                            } else {
                                quality -= 0.06;
                                if (quality < MIN_QUALITY) quality = MIN_QUALITY;
                                setTimeout(tryExport, 0);
                            }
                        };
                        tryExport();
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        }

        // Upload handler: create both thumbnail and full image, store both in Firestore
        window.handleUpload = async () => {
            const input = document.getElementById('photoInput');
            const price = document.getElementById('priceInput');
            const categorySelect = document.getElementById('categorySelect');
            if (!input.files[0]) return;
            document.getElementById('status').innerText = "COMPRESSING & UPLOADING...";
            try {
                const file = input.files[0];
                // create thumbnail and full image (in parallel)
                const [thumb, full] = await Promise.all([
                    compressFileToTarget(file, THUMB_TARGET_KB, THUMB_MAX_WIDTH),
                    compressFileToTarget(file, FULL_TARGET_KB, FULL_MAX_WIDTH)
                ]);
                await addDoc(collection(db, "event_photos"), {
                    thumb,
                    imageText: full,
                    price: price.value || "Request Quote",
                    category: categorySelect.value || "Marriage",
                    timestamp: new Date()
                });
                document.getElementById('status').innerText = "DONE.";
                // refresh view to show newest item (fast)
                resetAndLoad();
            } catch (err) {
                console.error("Upload error:", err);
                document.getElementById('status').innerText = "ERROR.";
            } finally {
                input.value = ""; price.value = ""; categorySelect.value = "Marriage";
                setTimeout(()=> document.getElementById('status').innerText = "", 2000);
            }
        };

        window.deleteItem = async (e, id) => {
            e.stopPropagation(); // stop modal from opening when clicking delete
            if (confirm("Permanently delete this?")) {
                try {
                    await deleteDoc(doc(db, "event_photos", id));
                    // refresh current view
                    resetAndLoad();
                } catch (err) {
                    console.error("Delete failed:", err);
                }
            }
        };

        // Modal handling: load full image (we stored full as a property on the card)
        function openModal(fullSrc, price, category) {
            const imgEl = document.getElementById('modalImg');
            const loader = document.getElementById('modalLoader');
            const wa = document.getElementById('waLink');
            loader.style.display = 'block';
            imgEl.style.display = 'none';
            document.getElementById('photoModal').classList.add('active');
            document.getElementById('photoModal').setAttribute('aria-hidden', 'false');

            // Pre-decode fullSrc if needed
            const pre = new Image();
            pre.src = fullSrc;
            pre.onload = () => {
                imgEl.src = fullSrc;
                const msg = encodeURIComponent(`Hi Alankar Events, I'm interested in this setup. Category: ${category}. Price: ${price}`);
                wa.href = `https://wa.me/916361755076?text=${msg}`;
                loader.style.display = 'none';
                imgEl.style.display = 'block';
            };
            pre.onerror = () => {
                imgEl.src = fullSrc;
                loader.style.display = 'none';
                imgEl.style.display = 'block';
            };
        }

        function closeModal() {
            document.getElementById('photoModal').classList.remove('active');
            document.getElementById('photoModal').setAttribute('aria-hidden', 'true');
            document.getElementById('modalImg').src = '';
        }

        // Lazy-loading using IntersectionObserver for thumbs
        const io = ('IntersectionObserver' in window) ? new IntersectionObserver((entries, obs) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    const src = img.dataset.src;
                    if (src) {
                        img.src = src;
                        img.removeAttribute('data-src');
                        img.decode?.().catch(()=>{});
                    }
                    obs.unobserve(img);
                }
            });
        }, { rootMargin: '200px' }) : null;

        // Render + Pagination using getDocs (fast initial paint, less realtime overhead)
        const galleryEl = document.getElementById('gallery');
        const loadMoreBtn = document.getElementById('loadMore');
        loadMoreBtn.addEventListener('click', () => loadPage());

        async function resetAndLoad() {
            lastVisible = null;
            galleryEl.innerHTML = '';
            document.getElementById('loadMoreWrap').style.display = 'block';
            await loadPage(true);
        }

        async function loadPage(initial = false) {
            loadMoreBtn.disabled = true;
            loadMoreBtn.innerText = "Loading...";
            try {
                let q;
                const col = collection(db, "event_photos");
                if (!lastVisible) {
                    q = query(col, orderBy("timestamp", "desc"), limit(PAGE_SIZE));
                } else {
                    q = query(col, orderBy("timestamp", "desc"), startAfter(lastVisible), limit(PAGE_SIZE));
                }
                const snap = await getDocs(q);
                if (snap.empty && !lastVisible) {
                    // no items
                    galleryEl.innerHTML = '<p style="text-align:center; color:var(--gold);">No photos yet.</p>';
                    document.getElementById('loadMoreWrap').style.display = 'none';
                    return;
                }

                // append results
                const frag = document.createDocumentFragment();
                for (const fbDoc of snap.docs) {
                    const d = fbDoc.data() || {};
                    if (!d.category) d.category = "Marriage";
                    const card = document.createElement('div');
                    card.className = "item-card";
                    card.onclick = () => openModal(card._full || d.imageText, d.price || "Request Quote", d.category || "Marriage");

                    // set stored full on card for quick modal open
                    card._full = d.imageText; // full base64
                    // use thumbnail for gallery display
                    const img = document.createElement('img');
                    img.alt = d.category || "Photo";
                    img.loading = 'lazy';
                    img.dataset.src = d.thumb || d.imageText; // fallback to full if no thumb
                    img.style.opacity = '0';
                    img.addEventListener('load', () => { img.style.transition = 'opacity .18s'; img.style.opacity = '1'; });

                    const wrapper = document.createElement('div');
                    wrapper.className = 'img-wrapper';
                    wrapper.appendChild(img);

                    // If thumb missing, schedule a background thumbnail creation (deferred)
                    if (!d.thumb && d.imageText) {
                        idle(async () => {
                            try {
                                const small = await compressDataUrlToTarget(d.imageText, THUMB_TARGET_KB, THUMB_MAX_WIDTH);
                                await updateDoc(doc(db, "event_photos", fbDoc.id), { thumb: small });
                            } catch (err) {
                                // ignore failures (security rules or other)
                                console.warn("Failed to create thumb", fbDoc.id, err);
                            }
                        });
                    }

                    // background compress full image (deferred) if it's too large
                    try {
                        const sizeKB = dataUrlSizeKB(d.imageText || "");
                        if (sizeKB > FULL_TARGET_KB + 8) {
                            idle(async () => {
                                try {
                                    const compressed = await compressDataUrlToTarget(d.imageText, FULL_TARGET_KB, FULL_MAX_WIDTH);
                                    await updateDoc(doc(db, "event_photos", fbDoc.id), { imageText: compressed });
                                } catch (err) {
                                    console.warn("Background compress failed for", fbDoc.id, err);
                                }
                            });
                        }
                    } catch (err) {
                        console.error("Size check failed", err);
                    }

                    // admin remove button if admin
                    if (isAdmin) {
                        const delBtn = document.createElement('button');
                        delBtn.className = 'del-btn';
                        delBtn.innerText = 'REMOVE';
                        delBtn.onclick = (e) => deleteItem(e, fbDoc.id);
                        card.appendChild(delBtn);
                    }

                    const badge = document.createElement('div');
                    badge.className = 'category-badge';
                    badge.innerText = d.category || "Marriage";

                    const priceTag = document.createElement('div');
                    priceTag.className = 'price-tag';
                    priceTag.innerText = d.price || "Request Quote";

                    card.appendChild(badge);
                    card.appendChild(wrapper);
                    card.appendChild(priceTag);

                    frag.appendChild(card);

                    if (io) io.observe(img);
                    else {
                        img.src = img.dataset.src;
                        img.decode?.().catch(()=>{});
                    }
                }

                galleryEl.appendChild(frag);

                // update lastVisible for pagination
                if (snap.docs.length > 0) {
                    lastVisible = snap.docs[snap.docs.length - 1];
                }

                // if we received less than a full page, hide load more
                if (snap.docs.length < PAGE_SIZE) {
                    document.getElementById('loadMoreWrap').style.display = 'none';
                } else {
                    document.getElementById('loadMoreWrap').style.display = 'block';
                }

            } catch (err) {
                console.error("Failed to load page", err);
            } finally {
                loadMoreBtn.disabled = false;
                loadMoreBtn.innerText = "Load more";
            }
        }

        // initial load
        resetAndLoad();
    </script>
</body>
</html>
