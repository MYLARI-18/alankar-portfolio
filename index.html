
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Alankar Events | Premium Collection</title>

    <!-- Performance: preconnect fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;1,400&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        :root { 
            --gold: #d4af37; 
            --bg-black: #070606; 
            --white: #ffffff; 
            --muted: rgba(255,255,255,0.06);
        }

        /* Global */
        html,body { height:100%; }
        body { 
            font-family: 'Poppins', sans-serif; 
            margin: 0; 
            background: var(--bg-black);
            color: var(--white); 
            overflow-x: hidden;
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
        }

        header { padding: 56px 16px 20px; text-align: center; position:relative; z-index:2; }
        header h1 { 
            font-family: 'Playfair Display', serif; 
            font-size: clamp(2.2rem, 10vw, 4rem); 
            margin: 0; 
            letter-spacing: 8px; 
            text-transform: uppercase;
            background: linear-gradient(90deg, rgba(138,109,26,1), #fff9e6 40%, rgba(138,109,26,1));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 4px 10px rgba(0,0,0,0.6);
        }
        header p { color: var(--gold); text-transform: uppercase; letter-spacing: 6px; font-size: 0.75rem; margin-top: 12px; opacity:0.95; }

        #gallery { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); 
            gap: 20px; 
            padding: 20px; 
            max-width: 1200px; 
            margin: 0 auto 20px auto; 
            position:relative;
            z-index:2;
        }

        /* Card (lightweight but luxurious) */
        .item-card { 
            position: relative; 
            overflow: hidden; 
            cursor: pointer; 
            background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.01));
            border-radius: 12px; 
            border: 1px solid rgba(212,175,55,0.06);
            box-shadow: 0 6px 18px rgba(0,0,0,0.45);
            transition: transform 220ms ease, box-shadow 220ms ease;
            transform-origin: center;
            will-change: transform, opacity;
            min-height: 320px;
            display:flex;
            flex-direction:column;

            opacity: 0;
            transform: translateY(10px);
            animation: cardIn 420ms cubic-bezier(.2,.9,.3,1) forwards;
            animation-delay: calc(var(--i, 0) * 60ms);
        }

        @keyframes cardIn { to { opacity: 1; transform: translateY(0); } }

        .item-card:hover { 
            transform: translateY(-8px);
            box-shadow: 0 18px 44px rgba(0,0,0,0.55);
        }

        .img-wrapper { 
            overflow: hidden; 
            width: 100%; 
            aspect-ratio: 1/1.2; 
            position:relative;
            background: linear-gradient(90deg,#0a0a0a,#0c0c0c);
            display:block;
        }

        .item-card img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            transition: transform 360ms ease, filter 280ms ease, opacity 160ms ease; 
            display: block;
            will-change: transform, opacity;
            transform-origin: center;
        }

        .item-card:hover img {
            transform: scale(1.035);
            filter: contrast(1.03);
        }

        .price-tag { 
            position: absolute; 
            bottom: 10px; 
            left: 10px; 
            right: 10px;
            background: linear-gradient(90deg, rgba(212,175,55,0.95), rgba(255,241,184,0.92));
            padding: 8px 12px; 
            font-weight: 700; 
            font-size: 0.9rem; 
            letter-spacing: 1px; 
            color: black;
            text-align: center;
            border-radius: 10px;
            pointer-events: none;
        }

        .category-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 98;
            background: rgba(0,0,0,0.45);
            color: var(--gold);
            padding: 6px 10px;
            font-size: 11px;
            border-radius: 999px;
            letter-spacing: 0.6px;
            text-transform: uppercase;
            pointer-events: none;
            border: 1px solid rgba(212,175,55,0.08);
        }

        .del-btn, .edit-btn { 
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 99;
            background: #ff5252;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 10px;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
            margin-left: 8px;
        }

        .edit-btn {
            background: rgba(212,175,55,0.95);
            color: black;
            right: 86px;
        }

        /* edit panel inside card (admin) */
        .edit-panel {
            position: absolute;
            top: 48px;
            right: 10px;
            z-index: 999;
            width: 220px;
            background: #0b0b0b;
            border: 1px solid rgba(212,175,55,0.08);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 8px 28px rgba(0,0,0,0.6);
        }
        .edit-panel input, .edit-panel select, .edit-panel button {
            width: 100%;
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #333;
            background: #111;
            color: white;
            font-size: 13px;
        }
        .edit-panel .save-btn { background: linear-gradient(90deg,#d4af37,#f5e2a6); color: black; border: none; font-weight: 700; cursor: pointer; }
        .edit-panel .cancel-btn { background: transparent; color: var(--gold); border: 1px solid rgba(212,175,55,0.12); }

        /* skeleton loader (gallery) */
        .skeleton-card {
            border-radius: 12px;
            background: linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
            min-height: 320px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 6px 18px rgba(0,0,0,0.45);
        }
        .skeleton-anim {
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, rgba(255,255,255,0.01) 0%, rgba(255,255,255,0.03) 50%, rgba(255,255,255,0.01) 100%);
            animation: shimmer 1.2s infinite;
        }
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* modal simplified */
        #photoModal { 
            display: none; 
            position: fixed; 
            inset: 0; 
            z-index: 9999; 
            align-items: center; 
            justify-content: center; 
            background: rgba(0,0,0,0.85);
        }
        #photoModal.active { display: flex; }
        .modal-container { position: relative; max-width: 92%; text-align: center; }
        .modal-content { max-height: 82vh; max-width: 100%; border-radius: 12px; border: 1px solid rgba(212,175,55,0.08); display:block; margin:0 auto; box-shadow: 0 30px 60px rgba(0,0,0,0.6); }
        .modal-loader { color: var(--gold); padding: 24px 0; display:flex; align-items:center; justify-content:center; gap:12px; }
        .spinner {
            width: 28px; height: 28px; border-radius: 50%;
            border: 3px solid rgba(255,255,255,0.08); border-top-color: var(--gold);
            animation: spin 0.9s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .wa-btn { 
            display: inline-block; 
            margin-top: 12px; 
            background: linear-gradient(90deg, rgba(212,175,55,1), rgba(255,241,184,0.95)); 
            color: black; 
            padding: 10px 20px; 
            text-decoration: none; 
            border-radius: 999px; 
            font-weight: 700; 
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 1.6px;
        }

        /* admin panel simplified */
        #adminPanel { display: none; background: linear-gradient(180deg,#060606,#0b0b0b); padding: 48px 16px; border-top: 1px solid rgba(212,175,55,0.04); }
        .admin-card { max-width: 420px; margin: 0 auto; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding: 18px; border-radius: 10px; border: 1px solid rgba(212,175,55,0.06); }
        input, select, .btn-post { width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 6px; border: 1px solid #333; background: #111; color: white; }
        .btn-post { background: linear-gradient(90deg,#d4af37,#f5e2a6); color: black; border: none; font-weight: 700; cursor: pointer; }

        footer { padding: 40px 16px; text-align: center; opacity: 0.8; font-size: 10px; letter-spacing: 5px; color: var(--gold); position:relative; z-index:2; }

        /* Load more + retry */
        #loadMoreWrap { text-align:center; margin-bottom: 40px; }
        /* Unique, luxurious load button */
        .load-btn {
            --padx: 18px;
            --pady: 10px;
            display:inline-flex;
            align-items:center;
            gap:10px;
            padding: var(--pady) var(--padx);
            border-radius: 999px;
            background: linear-gradient(90deg, rgba(212,175,55,1), rgba(255,241,184,0.95));
            color: #000;
            font-weight: 800;
            letter-spacing: 1.2px;
            border: none;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(212,175,55,0.08);
            transform-origin:center;
            transition: transform .18s ease, box-shadow .18s ease, opacity .18s ease;
        }
        .load-btn:active { transform: translateY(1px) scale(.998); }
        .load-btn[disabled] { opacity: .6; cursor: default; transform: none; box-shadow: none; }

        /* small inline spinner/dots inside button */
        .btn-spinner {
            width: 18px;
            height: 18px;
            position: relative;
            display:inline-block;
        }
        .dots > span {
            display:inline-block;
            width:4px; height:4px;
            margin-right:3px;
            border-radius:50%;
            background:#000;
            opacity:0.95;
            transform: translateY(0);
            animation: dotPulse 900ms infinite ease-in-out;
        }
        .dots > span:nth-child(2){ animation-delay: 120ms; }
        .dots > span:nth-child(3){ animation-delay: 240ms; margin-right:0; }
        @keyframes dotPulse {
            0% { transform: translateY(0); opacity:0.5; }
            50% { transform: translateY(-4px); opacity:1; }
            100% { transform: translateY(0); opacity:0.5; }
        }

        /* loading state with subtle glow */
        .load-btn.loading { box-shadow: 0 18px 44px rgba(212,175,55,0.14), 0 6px 20px rgba(0,0,0,0.45); transform: translateY(-3px); }

        #loadError { display:none; text-align:center; margin: 12px 0; color: #ffb86b; }
        #btnRetry { background: rgba(212,175,55,0.95); border: none; color: #000; padding: 8px 14px; border-radius: 8px; cursor:pointer; }

        /* small responsive tweaks */
        @media (max-width:420px){
            .load-btn { --padx: 12px; --pady: 8px; font-size: 13px; }
        }
    </style>
</head>
<body>

    <header>
        <h1>ALANKAR EVENTS</h1>
        <p>A Legacy of Luxury</p>
    </header>

    <div id="gallery" aria-live="polite"></div>

    <div id="loadMoreWrap" aria-live="polite">
        <button id="loadMore" class="load-btn" aria-label="Load more items" aria-busy="false">
            <span id="loadLabel">Explore more</span>
            <span class="btn-spinner" aria-hidden="true" style="display:none">
                <span class="dots"><span></span><span></span><span></span></span>
            </span>
        </button>
    </div>

    <div id="loadError"><span id="errMsg"></span><br><button id="btnRetry">Retry</button></div>

    <div id="photoModal" role="dialog" aria-modal="true" aria-hidden="true">
        <div class="modal-container">
            <span id="modalClose" onclick="closeModal()" role="button" aria-label="Close modal" style="position:absolute; top:12px; right:12px; color:var(--gold); font-size:36px; cursor:pointer;">&times;</span>
            <div class="modal-loader" id="modalLoader"><div class="spinner" aria-hidden="true"></div><div id="modalLoaderText">Loading…</div></div>
            <img class="modal-content" id="modalImg" alt="Enlarged photo" style="display:none;">
            <br>
            <a id="waLink" href="#" target="_blank" class="wa-btn" style="display:none">Inquire on WhatsApp</a>
        </div>
    </div>

    <div id="adminPanel">
        <div class="admin-card">
            <h2 style="text-align:center; color:var(--gold)">Admin Studio</h2>
            <input type="file" id="photoInput" accept="image/*">
            <input type="text" id="priceInput" placeholder="Price (e.g. ₹80,000)">
            <select id="categorySelect" title="Select category">
                <option value="Marriage" selected>Marriage</option>
                <option value="Birthday">Birthday</option>
                <option value="Babyshower">Babyshower</option>
                <option value="Other">Other</option>
            </select>
            <button class="btn-post" onclick="handleUpload()">Post to Gallery</button>
            <p id="status" style="font-size:12px; color:var(--gold); text-align:center;"></p>
        </div>
    </div>

    <footer onclick="secretClick()">© ALANKAR EVENTS</footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, getDocs, limit, startAfter, deleteDoc, doc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDCBOg_FlIpVZyBYVW6yFUcgU7gwIUD1Ks",
            authDomain: "alankar-luxe.firebaseapp.com",
            projectId: "alankar-luxe",
            messagingSenderId: "1093775711292",
            appId: "1:1093775711292:web:30ffd3741a16c10ce9b739"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Perf-tuned constants
        const PAGE_SIZE = 9;
        const THUMB_TARGET_KB = 18;
        const THUMB_MAX_WIDTH = 420;
        const FULL_TARGET_KB = 50;
        const FULL_MAX_WIDTH = 900;
        const MIN_QUALITY = 0.45;

        let isAdmin = false;
        let clickCount = 0;
        let lastVisible = null;
        const idle = window.requestIdleCallback ? window.requestIdleCallback.bind(window) : (cb) => setTimeout(cb, 500);

        // small inline svg placeholder (very small, fast)
        const svgPlaceholder = encodeURIComponent(
            `<svg xmlns='http://www.w3.org/2000/svg' width='24' height='30' viewBox='0 0 24 30'>
                <defs><linearGradient id='g' x1='0' x2='1' y1='0' y2='1'><stop offset='0' stop-color='#0b0b0b'/><stop offset='1' stop-color='#1a1a1a'/></linearGradient></defs>
                <rect width='100%' height='100%' fill='url(#g)' />
                <g fill='${encodeURIComponent('#d4af37')}' opacity='0.06'>
                  <circle cx='6' cy='8' r='5'/><circle cx='18' cy='18' r='6'/>
                </g>
            </svg>`
        );
        const placeholderDataUrl = `data:image/svg+xml;utf8,${svgPlaceholder}`;

        // secret admin toggle
        window.secretClick = () => {
            clickCount++;
            if (clickCount === 5) {
                const pass = prompt("Key:");
                if (pass === "alankar777") {
                    isAdmin = true;
                    document.getElementById('adminPanel').style.display = 'block';
                    document.getElementById('adminPanel').scrollIntoView({behavior: 'smooth'});
                    resetAndLoad();
                }
                clickCount = 0;
            }
            setTimeout(() => { clickCount = 0; }, 3000);
        };

        // ===== utilities: retry wrapper to make transient network failures tolerable =====
        async function retry(fn, attempts = 3, delay = 500) {
            let lastErr;
            for (let i = 0; i < attempts; i++) {
                try {
                    return await fn();
                } catch (err) {
                    lastErr = err;
                    const back = delay * Math.pow(2, i) + Math.floor(Math.random() * 200);
                    await new Promise(r => setTimeout(r, back));
                }
            }
            throw lastErr;
        }

        function dataUrlSizeKB(dataUrl) {
            if (!dataUrl) return 0;
            const comma = dataUrl.indexOf(',');
            const b64 = dataUrl.slice(comma + 1);
            const padding = (b64.endsWith('==') ? 2 : b64.endsWith('=') ? 1 : 0);
            const bytes = (b64.length * 3) / 4 - padding;
            return bytes / 1024;
        }

        function compressDataUrlToTarget(dataUrl, targetKB = FULL_TARGET_KB, maxWidth = FULL_MAX_WIDTH) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.src = dataUrl;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const scale = Math.min(1, maxWidth / img.width);
                    canvas.width = Math.round(img.width * scale);
                    canvas.height = Math.round(img.height * scale);
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    let quality = 0.92;
                    const tryExport = () => {
                        const out = canvas.toDataURL('image/jpeg', quality);
                        if (dataUrlSizeKB(out) <= targetKB || quality <= MIN_QUALITY) {
                            resolve(out);
                        } else {
                            quality -= 0.06;
                            if (quality < MIN_QUALITY) quality = MIN_QUALITY;
                            setTimeout(tryExport, 0);
                        }
                    };
                    tryExport();
                };
                img.onerror = reject;
            });
        }

        function compressFileToTarget(file, targetKB = FULL_TARGET_KB, maxWidth = FULL_MAX_WIDTH) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const scale = Math.min(1, maxWidth / img.width);
                        canvas.width = Math.round(img.width * scale);
                        canvas.height = Math.round(img.height * scale);
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        let quality = 0.92;
                        const tryExport = () => {
                            const dataUrl = canvas.toDataURL('image/jpeg', quality);
                            if (dataUrlSizeKB(dataUrl) <= targetKB || quality <= MIN_QUALITY) {
                                resolve(dataUrl);
                            } else {
                                quality -= 0.06;
                                if (quality < MIN_QUALITY) quality = MIN_QUALITY;
                                setTimeout(tryExport, 0);
                            }
                        };
                        tryExport();
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        }

        // Upload handler (keeps 50KB target for full images)
        window.handleUpload = async () => {
            const input = document.getElementById('photoInput');
            const price = document.getElementById('priceInput');
            const categorySelect = document.getElementById('categorySelect');
            if (!input.files[0]) return;
            document.getElementById('status').innerText = "COMPRESSING & UPLOADING...";
            try {
                const file = input.files[0];
                const [thumb, full] = await Promise.all([
                    compressFileToTarget(file, THUMB_TARGET_KB, THUMB_MAX_WIDTH),
                    compressFileToTarget(file, FULL_TARGET_KB, FULL_MAX_WIDTH)
                ]);
                await addDoc(collection(db, "event_photos"), {
                    thumb,
                    imageText: full,
                    price: price.value || "Request Quote",
                    category: categorySelect.value || "Marriage",
                    timestamp: new Date(),
                    compressedAt: new Date()
                });
                document.getElementById('status').innerText = "DONE.";
                resetAndLoad();
            } catch (err) {
                console.error("Upload error:", err);
                document.getElementById('status').innerText = "ERROR.";
            } finally {
                input.value = ""; price.value = ""; categorySelect.value = "Marriage";
                setTimeout(()=> document.getElementById('status').innerText = "", 2000);
            }
        };

        window.deleteItem = async (e, id) => {
            e.stopPropagation();
            if (confirm("Permanently delete this?")) {
                try {
                    await deleteDoc(doc(db, "event_photos", id));
                    resetAndLoad();
                } catch (err) {
                    console.error("Delete failed:", err);
                }
            }
        };

        async function updateItemFields(e, id, fields, panel) {
            e.stopPropagation();
            try {
                panel.querySelector('.save-btn').disabled = true;
                await updateDoc(doc(db, "event_photos", id), fields);
                panel.querySelector('.save-btn').innerText = "Saved";
                setTimeout(()=> resetAndLoad(), 700);
            } catch (err) {
                console.error("Update failed", err);
                panel.querySelector('.save-btn').innerText = "Error";
                panel.querySelector('.save-btn').disabled = false;
            }
        }

        // modal: fetch full with retry to tolerate network blips
        async function openModal(card) {
            const imgEl = document.getElementById('modalImg');
            const loader = document.getElementById('modalLoader');
            const wa = document.getElementById('waLink');
            loader.style.display = 'flex';
            imgEl.style.display = 'none';
            wa.style.display = 'none';
            document.getElementById('photoModal').classList.add('active');
            document.getElementById('photoModal').setAttribute('aria-hidden', 'false');

            if (card._full) {
                imgEl.src = card._full;
                imgEl.onload = () => { loader.style.display = 'none'; imgEl.style.display = 'block'; };
                const msg = encodeURIComponent(`Hi Alankar Events, I'm interested in this setup. Category: ${card._category}. Price: ${card._price}`);
                wa.href = `https://wa.me/916361755076?text=${msg}`;
                wa.style.display = 'inline-block';
                return;
            }

            try {
                const remote = await retry(() => getDoc(doc(db, "event_photos", card._id)), 3, 500);
                const data = remote.data() || {};
                const fullSrc = data.imageText;
                card._full = fullSrc;
                card._category = data.category || card._category;
                card._price = data.price || card._price;

                const pre = new Image();
                pre.src = fullSrc;
                pre.onload = () => {
                    imgEl.src = fullSrc;
                    const msg = encodeURIComponent(`Hi Alankar Events, I'm interested in this setup. Category: ${card._category}. Price: ${card._price}`);
                    wa.href = `https://wa.me/916361755076?text=${msg}`;
                    loader.style.display = 'none';
                    imgEl.style.display = 'block';
                    wa.style.display = 'inline-block';
                };
                pre.onerror = () => {
                    imgEl.src = fullSrc;
                    loader.style.display = 'none';
                    imgEl.style.display = 'block';
                    wa.style.display = 'inline-block';
                };
            } catch (err) {
                console.error("Failed to fetch full image", err);
                document.getElementById('modalLoaderText').innerText = 'Failed to load. Try again.';
                setTimeout(()=> closeModal(), 1500);
            }
        }

        function closeModal() {
            document.getElementById('photoModal').classList.remove('active');
            document.getElementById('photoModal').setAttribute('aria-hidden', 'true');
            document.getElementById('modalImg').src = '';
            document.getElementById('waLink').style.display = 'none';
            document.getElementById('modalLoaderText').innerText = 'Loading…';
        }

        document.addEventListener('keydown', (e) => {
            const modal = document.getElementById('photoModal');
            if (modal && modal.classList.contains('active') && (e.key === 'Escape' || e.key === 'Esc')) {
                closeModal();
            }
        });

        document.getElementById('photoModal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeModal();
        });

        // IntersectionObserver for lazy-loading thumbs
        const io = ('IntersectionObserver' in window) ? new IntersectionObserver((entries, obs) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    const src = img.dataset.src;
                    if (src) {
                        requestAnimationFrame(() => {
                            img.src = src;
                            img.removeAttribute('data-src');
                            img.decode?.().catch(()=>{});
                        });
                    }
                    obs.unobserve(img);
                }
            });
        }, { rootMargin: '300px' }) : null;

        const galleryEl = document.getElementById('gallery');
        const loadMoreBtn = document.getElementById('loadMore');
        const loadLabel = document.getElementById('loadLabel');
        const btnSpinner = loadMoreBtn.querySelector('.btn-spinner');
        const loadError = document.getElementById('loadError');
        const errMsg = document.getElementById('errMsg');
        const btnRetry = document.getElementById('btnRetry');
        loadMoreBtn.addEventListener('click', () => loadPage());
        btnRetry.addEventListener('click', () => { loadError.style.display = 'none'; resetAndLoad(); });

        function setLoadingUI(on, text = "Loading...") {
            if (on) {
                loadMoreBtn.classList.add('loading');
                loadLabel.innerText = text;
                btnSpinner.style.display = 'inline-block';
                loadMoreBtn.disabled = true;
                loadMoreBtn.setAttribute('aria-busy', 'true');
            } else {
                loadMoreBtn.classList.remove('loading');
                loadLabel.innerText = 'Explore more';
                btnSpinner.style.display = 'none';
                loadMoreBtn.disabled = false;
                loadMoreBtn.setAttribute('aria-busy', 'false');
            }
        }

        function showSkeleton(count = PAGE_SIZE) {
            galleryEl.innerHTML = '';
            const frag = document.createDocumentFragment();
            for (let i = 0; i < count; i++) {
                const s = document.createElement('div');
                s.className = 'skeleton-card';
                const anim = document.createElement('div');
                anim.className = 'skeleton-anim';
                s.appendChild(anim);
                frag.appendChild(s);
            }
            galleryEl.appendChild(frag);
        }

        async function resetAndLoad() {
            lastVisible = null;
            showSkeleton(6);
            document.getElementById('loadMoreWrap').style.display = 'block';
            await loadPage(true);
        }

        async function loadPage(initial = false) {
            if (loadMoreBtn.disabled) return;
            setLoadingUI(true, 'Loading…');
            try {
                let q;
                const col = collection(db, "event_photos");
                if (!lastVisible) {
                    q = query(col, orderBy("timestamp", "desc"), limit(PAGE_SIZE));
                } else {
                    q = query(col, orderBy("timestamp", "desc"), startAfter(lastVisible), limit(PAGE_SIZE));
                }

                const snap = await retry(() => getDocs(q), 3, 600);

                if (snap.empty && !lastVisible) {
                    galleryEl.innerHTML = '<p style="text-align:center; color:var(--gold);">No photos yet.</p>';
                    document.getElementById('loadMoreWrap').style.display = 'none';
                    setLoadingUI(false);
                    return;
                }

                const frag = document.createDocumentFragment();
                let seq = 0;
                for (const fbDoc of snap.docs) {
                    const d = fbDoc.data() || {};
                    if (!d.category) d.category = "Marriage";

                    const card = document.createElement('div');
                    card.className = "item-card";
                    card.style.setProperty('--i', seq++);

                    card._id = fbDoc.id;
                    card._category = d.category || "Marriage";
                    card._price = d.price || "Request Quote";

                    try {
                        const sizeKB = dataUrlSizeKB(d.imageText || "");
                        if ((sizeKB > 0 && sizeKB <= FULL_TARGET_KB + 6)) {
                            card._full = d.imageText;
                        } else {
                            card._full = null;
                        }
                    } catch (err) {
                        card._full = null;
                    }

                    card.onclick = () => openModal(card);

                    const wrapper = document.createElement('div');
                    wrapper.className = 'img-wrapper';

                    const img = document.createElement('img');
                    img.alt = d.category || "Photo";
                    img.loading = 'lazy';
                    // Use thumb if available; otherwise show tiny placeholder and defer creating thumb
                    img.dataset.src = d.thumb || '';
                    img.src = d.thumb ? placeholderDataUrl : placeholderDataUrl;
                    img.style.opacity = '0';
                    img.addEventListener('load', () => { img.style.transition = 'opacity .18s'; img.style.opacity = '1'; });

                    wrapper.appendChild(img);
                    card.appendChild(wrapper);

                    if (!d.thumb && d.imageText) {
                        idle(async () => {
                            try {
                                const small = await compressDataUrlToTarget(d.imageText, THUMB_TARGET_KB, THUMB_MAX_WIDTH);
                                await updateDoc(doc(db, "event_photos", fbDoc.id), { thumb: small }).catch(()=>{});
                            } catch (err) {
                                console.warn("Failed to create thumb", fbDoc.id, err);
                            }
                        });
                    }

                    try {
                        const fullKB = dataUrlSizeKB(d.imageText || "");
                        if (fullKB > FULL_TARGET_KB + 4 && !d.compressedAt) {
                            idle(async () => {
                                try {
                                    const compressed = await compressDataUrlToTarget(d.imageText, FULL_TARGET_KB, FULL_MAX_WIDTH);
                                    await updateDoc(doc(db, "event_photos", fbDoc.id), { imageText: compressed, compressedAt: new Date() });
                                    const small = await compressDataUrlToTarget(compressed, THUMB_TARGET_KB, THUMB_MAX_WIDTH);
                                    await updateDoc(doc(db, "event_photos", fbDoc.id), { thumb: small }).catch(()=>{});
                                } catch (err) {
                                    console.warn("Background compression failed for", fbDoc.id, err);
                                }
                            });
                        }
                    } catch (err) { /* ignore */ }

                    if (isAdmin) {
                        const delBtn = document.createElement('button');
                        delBtn.className = 'del-btn';
                        delBtn.innerText = 'REMOVE';
                        delBtn.onclick = (e) => deleteItem(e, fbDoc.id);
                        card.appendChild(delBtn);

                        const editBtn = document.createElement('button');
                        editBtn.className = 'edit-btn';
                        editBtn.innerText = 'EDIT';
                        editBtn.onclick = (e) => {
                            e.stopPropagation();
                            const existing = card.querySelector('.edit-panel');
                            if (existing) { existing.remove(); return; }
                            const panel = document.createElement('div');
                            panel.className = 'edit-panel';
                            const priceInput = document.createElement('input');
                            priceInput.value = d.price || '';
                            priceInput.placeholder = 'Price';
                            const catSelect = document.createElement('select');
                            ['Marriage','Birthday','Babyshower','Other'].forEach(v => {
                                const o = document.createElement('option');
                                o.value = v; o.innerText = v;
                                if (v === (d.category || 'Marriage')) o.selected = true;
                                catSelect.appendChild(o);
                            });
                            const saveBtn = document.createElement('button');
                            saveBtn.className = 'save-btn';
                            saveBtn.innerText = 'Save';
                            saveBtn.onclick = (ev) => updateItemFields(ev, fbDoc.id, { price: priceInput.value || 'Request Quote', category: catSelect.value || 'Other' }, panel);
                            const cancelBtn = document.createElement('button');
                            cancelBtn.className = 'cancel-btn';
                            cancelBtn.innerText = 'Cancel';
                            cancelBtn.onclick = (ev) => { ev.stopPropagation(); panel.remove(); };

                            panel.appendChild(priceInput);
                            panel.appendChild(catSelect);
                            panel.appendChild(saveBtn);
                            panel.appendChild(cancelBtn);
                            card.appendChild(panel);
                        };
                        card.appendChild(editBtn);
                    }

                    const badge = document.createElement('div');
                    badge.className = 'category-badge';
                    badge.innerText = d.category || "Marriage";

                    const priceTag = document.createElement('div');
                    priceTag.className = 'price-tag';
                    priceTag.innerText = d.price || "Request Quote";

                    card.appendChild(badge);
                    card.appendChild(priceTag);

                    frag.appendChild(card);

                    if (io && img.dataset.src) io.observe(img);
                    else if (img.dataset.src) {
                        img.src = img.dataset.src;
                        img.decode?.().catch(()=>{});
                    }
                }

                if (!lastVisible) galleryEl.innerHTML = '';
                galleryEl.appendChild(frag);

                if (snap.docs.length > 0) lastVisible = snap.docs[snap.docs.length - 1];

                if (snap.docs.length < PAGE_SIZE) document.getElementById('loadMoreWrap').style.display = 'none';
                else document.getElementById('loadMoreWrap').style.display = 'block';

                loadError.style.display = 'none';
            } catch (err) {
                console.error("Failed to load page", err);
                errMsg.innerText = 'Connection problem — tap Retry or try again later.';
                loadError.style.display = 'block';
            } finally {
                // small delay to avoid flash when loads are super-fast
                setTimeout(()=> setLoadingUI(false), 300);
            }
        }

        // initial load
        resetAndLoad();

        // ---- Service worker embedded registration (sw code is created as a Blob at runtime)
        // Note: having the service worker code inside the HTML lets you ship a single file.
        // Browser support: Chrome/Firefox accept blob-based registrations. Safari has limited support.
        if ('serviceWorker' in navigator) {
            (async function registerInlineSW(){
                const swScript = `
// Small service worker to cache static shell and provide basic runtime caching for repeated visits.
// Strategy: precache shell + runtime cache-first for assets + network-first for navigations.

const SW_VERSION = 'alankar-sw-v1';
const PRECACHE = [
  './',
  './index.html'
];
const RUNTIME_CACHE = 'alankar-runtime-v1';

self.addEventListener('install', (event) => {
  event.waitUntil(
    caches.open(SW_VERSION).then(cache => cache.addAll(PRECACHE)).then(() => self.skipWaiting())
  );
});

self.addEventListener('activate', (event) => {
  event.waitUntil(
    caches.keys().then(keys => Promise.all(
      keys.filter(k => k !== SW_VERSION && k !== RUNTIME_CACHE).map(k => caches.delete(k))
    )).then(() => self.clients.claim())
  );
});

async function networkFirst(request) {
  const cache = await caches.open(RUNTIME_CACHE);
  try {
    const response = await fetch(request);
    if (response && response.ok) cache.put(request, response.clone());
    return response;
  } catch (err) {
    const cached = await cache.match(request);
    if (cached) return cached;
    throw err;
  }
}

async function cacheFirst(request) {
  const cache = await caches.open(RUNTIME_CACHE);
  const cached = await cache.match(request);
  if (cached) {
    fetch(request).then(resp => {
      if (resp && resp.ok) cache.put(request, resp.clone());
    }).catch(()=>{});
    return cached;
  }
  const response = await fetch(request);
  if (response && response.ok) cache.put(request, response.clone());
  return response;
}

self.addEventListener('fetch', (event) => {
  const req = event.request;
  const url = new URL(req.url);

  if (req.method !== 'GET') return;

  if (req.mode === 'navigate' || (req.headers.get('accept') || '').includes('text/html')) {
    event.respondWith(
      networkFirst(req).catch(() => caches.match('./index.html'))
    );
    return;
  }

  if (url.origin === self.location.origin) {
    if (req.destination === 'style' || req.destination === 'script' || req.destination === 'image' || req.destination === 'font') {
      event.respondWith(
        cacheFirst(req).catch(() => fetch(req))
      );
      return;
    }
  }

  event.respondWith(fetch(req).catch(() => caches.match(req)));
});
`.trim();

                try {
                    // create a blob from script and register it
                    const blob = new Blob([swScript], { type: 'text/javascript' });
                    const swUrl = URL.createObjectURL(blob);
                    const reg = await navigator.serviceWorker.register(swUrl, { scope: './' });
                    console.log('ServiceWorker registered from blob', reg);
                    // revoke the object URL; browser keeps the script for the registered worker
                    URL.revokeObjectURL(swUrl);
                } catch (err) {
                    // fallback: attempt to register external sw.js if present on server
                    console.warn('Blob-based SW registration failed, trying ./sw.js', err);
                    try {
                        await navigator.serviceWorker.register('./sw.js', { scope: './' });
                        console.log('ServiceWorker registered from ./sw.js');
                    } catch (e) {
                        console.warn('External sw.js registration also failed', e);
                    }
                }
            })();
        }
    </script>

    <!-- Legacy fallback for older browsers (nomodule) -->
    <script nomodule>
        (function(){
            function loadScript(src, cb){
                var s = document.createElement('script');
                s.src = src;
                s.onload = cb;
                s.onerror = function(){ cb(new Error('Failed to load ' + src)); };
                document.head.appendChild(s);
            }

            var firebaseBase = 'https://www.gstatic.com/firebasejs/9.23.0';
            loadScript(firebaseBase + '/firebase-app-compat.js', function(err){
                if (err) return fallbackMessage();
                loadScript(firebaseBase + '/firebase-firestore-compat.js', function(err2){
                    if (err2) return fallbackMessage();
                    try { initCompat(); } catch (e) { fallbackMessage(); }
                });
            });

            function fallbackMessage(){
                var g = document.getElementById('gallery');
                g.innerHTML = "<p style='text-align:center;color:#ffb86b'>This device could not load the full experience. Please try again or use a modern browser.</p>";
            }

            function initCompat(){
                var config = {
                    apiKey: "AIzaSyDCBOg_FlIpVZyBYVW6yFUcgU7gwIUD1Ks",
                    authDomain: "alankar-luxe.firebaseapp.com",
                    projectId: "alankar-luxe",
                    messagingSenderId: "1093775711292",
                    appId: "1:1093775711292:web:30ffd3741a16c10ce9b739"
                };
                firebase.initializeApp(config);
                var db = firebase.firestore();

                var PAGE_SIZE = 9;
                var galleryEl = document.getElementById('gallery');
                var loadMoreBtn = document.getElementById('loadMore');
                var lastVisible = null;

                function showSkeleton(n){ galleryEl.innerHTML=''; for(var i=0;i<n;i++){ var s=document.createElement('div'); s.className='skeleton-card'; var a=document.createElement('div'); a.className='skeleton-anim'; s.appendChild(a); galleryEl.appendChild(s);} }

                function simplePlaceholder(){
                    return 'data:image/svg+xml;utf8,' + encodeURIComponent("<svg xmlns='http://www.w3.org/2000/svg' width='24' height='30'><rect width='100%' height='100%' fill='#0b0b0b'/></svg>");
                }

                function renderDocs(docs){
                    var frag=document.createDocumentFragment();
                    for(var i=0;i<docs.length;i++){
                        var d = docs[i].data();
                        var card = document.createElement('div');
                        card.className='item-card';
                        card.style.setProperty('--i', i);
                        var wrapper = document.createElement('div'); wrapper.className='img-wrapper';
                        var img = document.createElement('img');
                        img.alt = d.category || 'Photo';
                        img.src = d.thumb || simplePlaceholder();
                        wrapper.appendChild(img);
                        card.appendChild(wrapper);
                        var badge = document.createElement('div'); badge.className='category-badge'; badge.innerText = d.category || 'Marriage';
                        var priceTag = document.createElement('div'); priceTag.className='price-tag'; priceTag.innerText = d.price || 'Request Quote';
                        card.appendChild(badge); card.appendChild(priceTag);

                        (function(id, data){
                            card.addEventListener('click', function(){
                                if (data.imageText) {
                                    var w = window.open('');
                                    w.document.write('<img src="'+data.imageText+'" style="max-width:100%;height:auto;display:block;margin:0 auto;background:#000">');
                                } else {
                                    alert('Full image not available');
                                }
                            });
                        })(docs[i].id, d);

                        frag.appendChild(card);
                    }
                    galleryEl.appendChild(frag);
                }

                function loadPage(){
                    showSkeleton(6);
                    var q;
                    if (!lastVisible) q = db.collection('event_photos').orderBy('timestamp','desc').limit(PAGE_SIZE);
                    else q = db.collection('event_photos').orderBy('timestamp','desc').startAfter(lastVisible).limit(PAGE_SIZE);
                    q.get().then(function(snap){
                        if (snap.empty && !lastVisible) {
                            galleryEl.innerHTML = '<p style="text-align:center; color:#d4af37">No photos yet.</p>';
                            document.getElementById('loadMoreWrap').style.display = 'none';
                            return;
                        }
                        var docs = snap.docs;
                        if (!lastVisible) galleryEl.innerHTML = '';
                        renderDocs(docs);
                        lastVisible = docs[docs.length-1];
                        if (docs.length < PAGE_SIZE) document.getElementById('loadMoreWrap').style.display = 'none';
                        else document.getElementById('loadMoreWrap').style.display = 'block';
                    }).catch(function(err){
                        console.error('Compat load failed', err);
                        galleryEl.innerHTML = "<p style='text-align:center;color:#ffb86b'>Connection problem. Try reloading.</p>";
                    });
                }

                loadMoreBtn.addEventListener('click', loadPage);
                loadPage();
            }
        })();
    </script>

</body>
</html>