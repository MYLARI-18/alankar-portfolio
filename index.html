<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Alankar Events | Premium Collection</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;1,400&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { 
            --gold: #d4af37; 
            --deep-gold: #8a6d1a;
            --bg-black: #070606; 
            --card-black: #0f0f10;
            --card-glass: rgba(255,255,255,0.03);
            --white: #ffffff; 
            --muted: #bdb3a0;
        }

        /* Global */
        html,body { height:100%; }
        body { 
            font-family: 'Poppins', sans-serif; 
            margin: 0; 
            background: radial-gradient(1200px 500px at 10% 10%, rgba(212,175,55,0.03), transparent),
                        radial-gradient(1000px 420px at 90% 85%, rgba(138,109,26,0.02), transparent),
                        var(--bg-black);
            color: var(--white); 
            overflow-x: hidden;
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
            background-attachment: fixed;
        }

        /* slight vignette for luxury depth */
        body::after {
            content: "";
            position: fixed;
            inset: 0;
            pointer-events: none;
            background: radial-gradient(1200px 700px at 50% 40%, rgba(255,255,255,0.02), transparent 20%),
                        linear-gradient(180deg, transparent, rgba(0,0,0,0.4));
            mix-blend-mode: multiply;
            opacity: 0.9;
        }

        /* --- ANIMATIONS --- */
        @keyframes revealUp { 
            0% { opacity: 0; transform: translateY(24px) scale(.995); filter: blur(8px); } 
            100% { opacity: 1; transform: translateY(0) scale(1); filter: blur(0); } 
        }

        @keyframes shimmerGold {
            0% { background-position: -200% center; }
            100% { background-position: 200% center; }
        }

        header { padding: 80px 20px 40px; text-align: center; position:relative; z-index:2; }
        header h1 { 
            font-family: 'Playfair Display', serif; 
            font-size: clamp(2.2rem, 10vw, 4rem); 
            margin: 0; 
            letter-spacing: 10px; 
            text-transform: uppercase;
            background: linear-gradient(90deg, rgba(138,109,26,1), #fff9e6 40%, rgba(138,109,26,1));
            background-size: 220% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: shimmerGold 5s linear infinite;
            text-shadow: 0 6px 18px rgba(10,10,10,0.7);
        }
        header p { color: var(--gold); text-transform: uppercase; letter-spacing: 8px; font-size: 0.75rem; margin-top: 20px; opacity:0.95; }

        #gallery { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 28px; 
            padding: 28px; 
            max-width: 1400px; 
            margin: 0 auto 80px auto; 
            position:relative;
            z-index:2;
        }

        /* Luxury card */
        .item-card { 
            position: relative; 
            overflow: hidden; 
            cursor: pointer; 
            opacity: 0; 
            animation: revealUp 600ms ease-out forwards;
            background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.015));
            border-radius: 16px; 
            border: 1px solid rgba(212,175,55,0.06);
            box-shadow:
                0 6px 18px rgba(0,0,0,0.6),
                0 18px 40px rgba(0,0,0,0.6),
                inset 0 1px 0 rgba(255,255,255,0.02);
            transition: transform 0.38s cubic-bezier(.2,.9,.2,1), box-shadow 0.38s, filter 0.38s;
            transform-origin: center;
            will-change: transform, box-shadow;
            backdrop-filter: blur(6px) saturate(110%);
        }

        .item-card:hover { 
            transform: translateY(-10px) scale(1.02);
            box-shadow:
                0 18px 60px rgba(5,5,5,0.75),
                0 6px 28px rgba(0,0,0,0.6),
                0 2px 0 rgba(212,175,55,0.02);
            filter: saturate(1.06) contrast(1.03);
        }

        .img-wrapper { 
            overflow: hidden; 
            width: 100%; 
            aspect-ratio: 1/1.2; 
            position:relative;
            background: linear-gradient(180deg,#0b0b0b, #0e0e0e);
        }

        /* glossy sheen overlay */
        .item-card::before {
            content: "";
            position: absolute;
            inset: 0;
            pointer-events: none;
            background: linear-gradient(120deg, rgba(255,255,255,0.02) 0%, rgba(255,255,255,0.0) 20%, rgba(212,175,55,0.02) 60%, rgba(0,0,0,0.15) 100%);
            mix-blend-mode: overlay;
            transition: opacity .4s;
        }

        .item-card::after {
            /* subtle rounded highlight at top-left */
            content: "";
            position: absolute;
            top: -40%;
            left: -10%;
            width: 140%;
            height: 80%;
            transform: rotate(-18deg);
            background: radial-gradient(600px 120px at 20% 30%, rgba(255,255,255,0.03), transparent 30%);
            pointer-events: none;
            opacity: 0.9;
        }

        .item-card img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            transition: transform 1.1s cubic-bezier(.2,.9,.2,1), filter .6s; 
            display: block;
            will-change: transform, opacity;
            transform-origin: center;
        }

        .item-card:hover img {
            transform: scale(1.06) rotate(-0.5deg);
            filter: contrast(1.03) brightness(1.02);
        }

        /* price tag: elevated gold strip */
        .price-tag { 
            position: absolute; 
            bottom: 12px; 
            left: 12px; 
            right: 12px;
            background: linear-gradient(90deg, rgba(212,175,55,0.98), rgba(255,241,184,0.95));
            padding: 10px 14px; 
            font-weight: 700; 
            font-size: 0.95rem; 
            letter-spacing: 1.5px; 
            color: black;
            text-align: center;
            border-radius: 12px;
            box-shadow: 0 6px 22px rgba(212,175,55,0.12), inset 0 -2px 6px rgba(0,0,0,0.18);
            pointer-events: none;
        }

        /* --- CATEGORY BADGE --- */
        .category-badge {
            position: absolute;
            top: 12px;
            left: 12px;
            z-index: 98;
            background: linear-gradient(180deg, rgba(0,0,0,0.5), rgba(0,0,0,0.38));
            color: var(--gold);
            padding: 6px 12px;
            font-size: 11px;
            border-radius: 50px;
            letter-spacing: 1px;
            text-transform: uppercase;
            pointer-events: none;
            border: 1px solid rgba(212,175,55,0.12);
            backdrop-filter: blur(4px);
            box-shadow: 0 6px 18px rgba(0,0,0,0.45);
        }

        /* --- DELETE BUTTON FIX --- */
        .del-btn { 
            position: absolute;
            top: 12px;
            right: 12px;
            z-index: 99; /* Higher than everything else */
            background: linear-gradient(180deg,#ff5c5c,#ff3030);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 50px;
            font-size: 10px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 8px 18px rgba(255, 77, 77, 0.25);
            text-transform: uppercase;
        }

        /* --- MODAL --- */
        #photoModal { 
            display: none; 
            position: fixed; 
            inset: 0; 
            z-index: 9999; 
            align-items: center; 
            justify-content: center; 
            backdrop-filter: blur(14px) saturate(120%); 
            background: linear-gradient(180deg, rgba(0,0,0,0.6), rgba(0,0,0,0.85));
        }
        #photoModal.active { display: flex; }
        .modal-container { position: relative; max-width: 88%; text-align: center; }
        .modal-content { max-height: 80vh; max-width: 100%; border-radius: 14px; border: 1px solid rgba(212,175,55,0.12); display:block; margin:0 auto; box-shadow: 0 30px 80px rgba(0,0,0,0.75), 0 8px 28px rgba(138,109,26,0.06); }
        .modal-loader { color: var(--gold); padding: 18px 0; display:none; }

        /* golden glow under modal */
        .modal-container::after {
            content: "";
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: -30px;
            width: 360px;
            height: 12px;
            background: radial-gradient(closest-side, rgba(212,175,55,0.14), transparent);
            filter: blur(18px);
            pointer-events: none;
        }

        .wa-btn { 
            display: inline-block; 
            margin-top: 18px; 
            background: linear-gradient(90deg, rgba(212,175,55,1), rgba(255,241,184,0.95)); 
            color: black; 
            padding: 12px 28px; 
            text-decoration: none; 
            border-radius: 50px; 
            font-weight: 700; 
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 2px;
            box-shadow: 0 10px 28px rgba(212,175,55,0.12), inset 0 -4px 10px rgba(0,0,0,0.12);
        }

        /* --- ADMIN PANEL --- */
        #adminPanel { display: none; background: linear-gradient(180deg,#060606,#0b0b0b); padding: 60px 20px; border-top: 1px solid rgba(212,175,55,0.06); }
        .admin-card { max-width: 420px; margin: 0 auto; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding: 26px; border-radius: 12px; border: 1px solid rgba(212,175,55,0.04); box-shadow: 0 18px 40px rgba(0,0,0,0.6); }
        input, select, .btn-post { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #333; background: #111; color: white; }
        select { appearance: none; -webkit-appearance: none; -moz-appearance: none; padding-right: 36px; text-transform: capitalize; }
        .btn-post { background: linear-gradient(90deg,#d4af37,#f5e2a6); color: black; border: none; font-weight: 700; cursor: pointer; box-shadow: 0 8px 20px rgba(212,175,55,0.12); }

        footer { padding: 60px 20px; text-align: center; opacity: 0.7; font-size: 10px; letter-spacing: 5px; cursor: pointer; color: var(--gold); position:relative; z-index:2; }
    </style>
</head>
<body>

    <header>
        <h1>ALANKAR EVENTS</h1>
        <p>A Legacy of Luxury</p>
    </header>

    <div id="gallery" aria-live="polite"></div>

    <div id="photoModal" role="dialog" aria-modal="true" aria-hidden="true">
        <div class="modal-container">
            <span id="modalClose" onclick="closeModal()" style="position:absolute; top:-55px; right:0; color:var(--gold); font-size:40px; cursor:pointer;">&times;</span>
            <div class="modal-loader" id="modalLoader">Loading…</div>
            <img class="modal-content" id="modalImg" alt="Enlarged photo">
            <br>
            <a id="waLink" href="#" target="_blank" class="wa-btn">Inquire on WhatsApp</a>
        </div>
    </div>

    <div id="adminPanel">
        <div class="admin-card">
            <h2 style="text-align:center; color:var(--gold)">Admin Studio</h2>
            <input type="file" id="photoInput" accept="image/*">
            <input type="text" id="priceInput" placeholder="Price (e.g. ₹80,000)">
            <select id="categorySelect" title="Select category">
                <option value="Marriage" selected>Marriage</option>
                <option value="Birthday">Birthday</option>
                <option value="Babyshower">Babyshower</option>
                <option value="Other">Other</option>
            </select>
            <button class="btn-post" onclick="handleUpload()">Post to Gallery</button>
            <p id="status" style="font-size:12px; color:var(--gold); text-align:center;"></p>
        </div>
    </div>

    <footer onclick="secretClick()">© ALANKAR EVENTS</footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDCBOg_FlIpVZyBYVW6yFUcgU7gwIUD1Ks",
            authDomain: "alankar-luxe.firebaseapp.com",
            projectId: "alankar-luxe",
            messagingSenderId: "1093775711292",
            appId: "1:1093775711292:web:30ffd3741a16c10ce9b739"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let isAdmin = false;
        let clickCount = 0;
        const TARGET_KB = 50;             // target size for images
        const MAX_WIDTH = 700;            // max width to resize to (keeps aspect ratio)
        const MIN_QUALITY = 0.45;         // don't go below this quality to avoid terrible artifacts

        // Secret admin toggle
        window.secretClick = () => {
            clickCount++;
            if (clickCount === 5) {
                const pass = prompt("Key:");
                if (pass === "alankar777") {
                    isAdmin = true;
                    document.getElementById('adminPanel').style.display = 'block';
                    document.getElementById('adminPanel').scrollIntoView({behavior: 'smooth'});
                    render(); // refresh render with admin button visible
                }
                clickCount = 0;
            }
            setTimeout(() => { clickCount = 0; }, 3000);
        };

        // Helpers: estimate size from base64 data URL
        function dataUrlSizeKB(dataUrl) {
            const comma = dataUrl.indexOf(',');
            const b64 = dataUrl.slice(comma + 1);
            const padding = (b64.endsWith('==') ? 2 : b64.endsWith('=') ? 1 : 0);
            const bytes = (b64.length * 3) / 4 - padding;
            return bytes / 1024;
        }

        // Compress a File to a dataURL targeting TARGET_KB
        function compressFileToTarget(file, targetKB = TARGET_KB) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        // Resize keeping aspect ratio to MAX_WIDTH
                        const canvas = document.createElement('canvas');
                        const scale = Math.min(1, MAX_WIDTH / img.width);
                        canvas.width = Math.round(img.width * scale);
                        canvas.height = Math.round(img.height * scale);
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                        // iteratively reduce quality to get under targetKB
                        let quality = 0.92;
                        const tryExport = () => {
                            const dataUrl = canvas.toDataURL('image/jpeg', quality);
                            if (dataUrlSizeKB(dataUrl) <= targetKB || quality <= MIN_QUALITY) {
                                resolve(dataUrl);
                            } else {
                                quality -= 0.06;
                                if (quality < MIN_QUALITY) quality = MIN_QUALITY;
                                // try again (allow browser event loop)
                                setTimeout(tryExport, 0);
                            }
                        };
                        tryExport();
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        }

        // Compress an existing dataURL (same approach) and return compressed dataURL
        function compressDataUrlToTarget(dataUrl, targetKB = TARGET_KB) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.src = dataUrl;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const scale = Math.min(1, MAX_WIDTH / img.width);
                    canvas.width = Math.round(img.width * scale);
                    canvas.height = Math.round(img.height * scale);
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                    let quality = 0.92;
                    const tryExport = () => {
                        const out = canvas.toDataURL('image/jpeg', quality);
                        if (dataUrlSizeKB(out) <= targetKB || quality <= MIN_QUALITY) {
                            resolve(out);
                        } else {
                            quality -= 0.06;
                            if (quality < MIN_QUALITY) quality = MIN_QUALITY;
                            setTimeout(tryExport, 0);
                        }
                    };
                    tryExport();
                };
                img.onerror = reject;
            });
        }

        // Upload handler: compress to target KB before sending
        window.handleUpload = async () => {
            const input = document.getElementById('photoInput');
            const price = document.getElementById('priceInput');
            const categorySelect = document.getElementById('categorySelect');
            if (!input.files[0]) return;
            document.getElementById('status').innerText = "COMPRESSING & UPLOADING...";
            try {
                const compressed = await compressFileToTarget(input.files[0], TARGET_KB);
                await addDoc(collection(db, "event_photos"), {
                    imageText: compressed,
                    price: price.value || "Request Quote",
                    category: categorySelect.value || "Marriage",
                    timestamp: new Date()
                });
                document.getElementById('status').innerText = "DONE.";
            } catch (err) {
                console.error("Upload error:", err);
                document.getElementById('status').innerText = "ERROR.";
            } finally {
                input.value = ""; price.value = ""; categorySelect.value = "Marriage";
                setTimeout(()=> document.getElementById('status').innerText = "", 2000);
            }
        };

        window.deleteItem = async (e, id) => {
            e.stopPropagation(); // stop modal from opening when clicking delete
            if (confirm("Permanently delete this?")) {
                try {
                    await deleteDoc(doc(db, "event_photos", id));
                } catch (err) {
                    console.error("Delete failed:", err);
                }
            }
        };

        // Modal handling: pre-decode image to avoid jank, show loader
        function openModal(src, price, category) {
            const imgEl = document.getElementById('modalImg');
            const loader = document.getElementById('modalLoader');
            const wa = document.getElementById('waLink');
            loader.style.display = 'block';
            imgEl.style.display = 'none';
            document.getElementById('photoModal').classList.add('active');
            document.getElementById('photoModal').setAttribute('aria-hidden', 'false');
            // pre-decode to avoid flicker
            const pre = new Image();
            pre.src = src;
            pre.onload = () => {
                imgEl.src = src;
                const msg = encodeURIComponent(`Hi Alankar Events, I'm interested in this setup. Category: ${category}. Price: ${price}`);
                wa.href = `https://wa.me/916361755076?text=${msg}`;
                loader.style.display = 'none';
                imgEl.style.display = 'block';
            };
            pre.onerror = () => {
                // still set and show
                imgEl.src = src;
                loader.style.display = 'none';
                imgEl.style.display = 'block';
            };
        }

        function closeModal() {
            document.getElementById('photoModal').classList.remove('active');
            document.getElementById('photoModal').setAttribute('aria-hidden', 'true');
            document.getElementById('modalImg').src = '';
        }

        // Lazy-loading utility using IntersectionObserver
        const io = ('IntersectionObserver' in window) ? new IntersectionObserver((entries, obs) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    const src = img.dataset.src;
                    if (src) {
                        img.src = src;
                        img.removeAttribute('data-src');
                        // decode will allow smoother display
                        img.decode?.().catch(()=>{});
                    }
                    obs.unobserve(img);
                }
            });
        }, { rootMargin: '200px' }) : null;

        // Render gallery optimized: build DocumentFragment, lazy load images and background compressing update
        function render() {
            const q = query(collection(db, "event_photos"), orderBy("timestamp", "desc"));
            onSnapshot(q, (snap) => {
                const gallery = document.getElementById('gallery');
                gallery.innerHTML = "";
                const frag = document.createDocumentFragment();
                const backgroundUpdates = [];
                snap.docs.forEach((fbDoc) => {
                    const d = fbDoc.data() || {};
                    // default category on client-side (fast)
                    if (!d.category) d.category = "Marriage";

                    const card = document.createElement('div');
                    card.className = "item-card";
                    // use data attributes for openModal params
                    const priceText = d.price || "Request Quote";
                    const category = d.category || "Marriage";

                    card.onclick = () => openModal(d.imageText, priceText, category);

                    // image element uses lazy loading. We set data-src and let the IO set .src when visible
                    const img = document.createElement('img');
                    img.alt = category;
                    img.loading = 'lazy';
                    img.dataset.src = d.imageText; // actual source (may be large)
                    img.style.opacity = '0';
                    img.addEventListener('load', () => { img.style.transition = 'opacity .25s'; img.style.opacity = '1'; });

                    const wrapper = document.createElement('div');
                    wrapper.className = 'img-wrapper';
                    wrapper.appendChild(img);

                    // If dataUrl is bigger than target, compress in background and update Firestore (non-blocking)
                    try {
                        const sizeKB = dataUrlSizeKB(d.imageText || "");
                        if (sizeKB > TARGET_KB + 2) { // small tolerance
                            // perform background compression and update but don't await it here
                            const updatePromise = compressDataUrlToTarget(d.imageText, TARGET_KB)
                                .then((compressed) => updateDoc(doc(db, "event_photos", fbDoc.id), { imageText: compressed }))
                                .catch(err => {
                                    // if update fails (rules auth), just ignore - we still render existing
                                    console.warn("Background compress/update failed for", fbDoc.id, err);
                                });
                            backgroundUpdates.push(updatePromise);
                        }
                    } catch (err) {
                        console.error("Size check failed", err);
                    }

                    // build card inner HTML (category badge + delete if admin)
                    if (isAdmin) {
                        const delBtn = document.createElement('button');
                        delBtn.className = 'del-btn';
                        delBtn.innerText = 'REMOVE';
                        delBtn.onclick = (e) => deleteItem(e, fbDoc.id);
                        card.appendChild(delBtn);
                    }

                    const badge = document.createElement('div');
                    badge.className = 'category-badge';
                    badge.innerText = category;

                    const priceTag = document.createElement('div');
                    priceTag.className = 'price-tag';
                    priceTag.innerText = priceText;

                    card.appendChild(badge);
                    card.appendChild(wrapper);
                    card.appendChild(priceTag);

                    frag.appendChild(card);

                    // Observe the image for lazy load
                    if (io) {
                        io.observe(img);
                    } else {
                        // fallback: set src immediately but let browser handle decoding
                        img.src = img.dataset.src;
                        img.decode?.().catch(()=>{});
                    }
                });

                // Insert gallery quickly
                gallery.appendChild(frag);

                // optional: let background updates run but don't block UI
                if (backgroundUpdates.length) {
                    Promise.allSettled(backgroundUpdates).then(()=> {
                        // no-op; updates completed
                    });
                }
            });
        }

        // initial render
        render();
    </script>
</body>
</html>
