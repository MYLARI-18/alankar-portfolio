<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Alankar Events | Premium Collection</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;1,400&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { 
            --gold: #d4af37; 
            --bg-black: #070606; 
            --white: #ffffff; 
            --muted: rgba(255,255,255,0.06);
        }

        /* Global */
        html,body { height:100%; }
        body { 
            font-family: 'Poppins', sans-serif; 
            margin: 0; 
            background: var(--bg-black);
            color: var(--white); 
            overflow-x: hidden;
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
        }

        header { padding: 56px 16px 20px; text-align: center; position:relative; z-index:2; }
        header h1 { 
            font-family: 'Playfair Display', serif; 
            font-size: clamp(2.2rem, 10vw, 4rem); 
            margin: 0; 
            letter-spacing: 8px; 
            text-transform: uppercase;
            background: linear-gradient(90deg, rgba(138,109,26,1), #fff9e6 40%, rgba(138,109,26,1));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 4px 10px rgba(0,0,0,0.6);
        }
        header p { color: var(--gold); text-transform: uppercase; letter-spacing: 6px; font-size: 0.75rem; margin-top: 12px; opacity:0.95; }

        #gallery { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); 
            gap: 20px; 
            padding: 20px; 
            max-width: 1200px; 
            margin: 0 auto 20px auto; 
            position:relative;
            z-index:2;
        }

        /* Card (lightweight but luxurious) */
        .item-card { 
            position: relative; 
            overflow: hidden; 
            cursor: pointer; 
            background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.01));
            border-radius: 12px; 
            border: 1px solid rgba(212,175,55,0.06);
            box-shadow: 0 6px 18px rgba(0,0,0,0.45);
            transition: transform 220ms ease, box-shadow 220ms ease;
            transform-origin: center;
            will-change: transform;
            min-height: 320px;
            display:flex;
            flex-direction:column;
        }

        .item-card:hover { 
            transform: translateY(-6px);
            box-shadow: 0 14px 36px rgba(0,0,0,0.55);
        }

        .img-wrapper { 
            overflow: hidden; 
            width: 100%; 
            aspect-ratio: 1/1.2; 
            position:relative;
            background: linear-gradient(90deg,#0a0a0a,#0c0c0c);
            display:block;
        }

        .item-card img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            transition: transform 360ms ease, filter 280ms ease, opacity 160ms ease; 
            display: block;
            will-change: transform, opacity;
            transform-origin: center;
        }

        .item-card:hover img {
            transform: scale(1.03);
            filter: contrast(1.02);
        }

        .price-tag { 
            position: absolute; 
            bottom: 10px; 
            left: 10px; 
            right: 10px;
            background: linear-gradient(90deg, rgba(212,175,55,0.95), rgba(255,241,184,0.92));
            padding: 8px 12px; 
            font-weight: 700; 
            font-size: 0.9rem; 
            letter-spacing: 1px; 
            color: black;
            text-align: center;
            border-radius: 10px;
            pointer-events: none;
        }

        .category-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 98;
            background: rgba(0,0,0,0.45);
            color: var(--gold);
            padding: 6px 10px;
            font-size: 11px;
            border-radius: 999px;
            letter-spacing: 0.6px;
            text-transform: uppercase;
            pointer-events: none;
            border: 1px solid rgba(212,175,55,0.08);
        }

        .del-btn, .edit-btn { 
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 99;
            background: #ff5252;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 10px;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
            margin-left: 8px;
        }

        .edit-btn {
            background: rgba(212,175,55,0.95);
            color: black;
            right: 86px;
        }

        /* edit panel inside card (admin) */
        .edit-panel {
            position: absolute;
            top: 48px;
            right: 10px;
            z-index: 999;
            width: 220px;
            background: #0b0b0b;
            border: 1px solid rgba(212,175,55,0.08);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 8px 28px rgba(0,0,0,0.6);
        }
        .edit-panel input, .edit-panel select, .edit-panel button {
            width: 100%;
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #333;
            background: #111;
            color: white;
            font-size: 13px;
        }
        .edit-panel .save-btn { background: linear-gradient(90deg,#d4af37,#f5e2a6); color: black; border: none; font-weight: 700; cursor: pointer; }
        .edit-panel .cancel-btn { background: transparent; color: var(--gold); border: 1px solid rgba(212,175,55,0.12); }

        /* skeleton loader (gallery) */
        .skeleton-card {
            border-radius: 12px;
            background: linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
            min-height: 320px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 6px 18px rgba(0,0,0,0.45);
        }
        .skeleton-anim {
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, rgba(255,255,255,0.01) 0%, rgba(255,255,255,0.03) 50%, rgba(255,255,255,0.01) 100%);
            animation: shimmer 1.2s infinite;
        }
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* modal simplified */
        #photoModal { 
            display: none; 
            position: fixed; 
            inset: 0; 
            z-index: 9999; 
            align-items: center; 
            justify-content: center; 
            background: rgba(0,0,0,0.85);
        }
        #photoModal.active { display: flex; }
        .modal-container { position: relative; max-width: 92%; text-align: center; }
        .modal-content { max-height: 82vh; max-width: 100%; border-radius: 12px; border: 1px solid rgba(212,175,55,0.08); display:block; margin:0 auto; box-shadow: 0 30px 60px rgba(0,0,0,0.6); }
        .modal-loader { color: var(--gold); padding: 24px 0; display:flex; align-items:center; justify-content:center; gap:12px; }
        .spinner {
            width: 28px; height: 28px; border-radius: 50%;
            border: 3px solid rgba(255,255,255,0.08); border-top-color: var(--gold);
            animation: spin 0.9s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .wa-btn { 
            display: inline-block; 
            margin-top: 12px; 
            background: linear-gradient(90deg, rgba(212,175,55,1), rgba(255,241,184,0.95)); 
            color: black; 
            padding: 10px 20px; 
            text-decoration: none; 
            border-radius: 999px; 
            font-weight: 700; 
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 1.6px;
        }

        /* admin panel simplified */
        #adminPanel { display: none; background: linear-gradient(180deg,#060606,#0b0b0b); padding: 48px 16px; border-top: 1px solid rgba(212,175,55,0.04); }
        .admin-card { max-width: 420px; margin: 0 auto; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding: 18px; border-radius: 10px; border: 1px solid rgba([...]
        input, select, .btn-post { width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 6px; border: 1px solid #333; background: #111; color: white; }
        .btn-post { background: linear-gradient(90deg,#d4af37,#f5e2a6); color: black; border: none; font-weight: 700; cursor: pointer; }

        footer { padding: 40px 16px; text-align: center; opacity: 0.8; font-size: 10px; letter-spacing: 5px; color: var(--gold); position:relative; z-index:2; }

        /* Load more */
        #loadMoreWrap { text-align:center; margin-bottom: 40px; }
        #loadMore { background: transparent; border: 1px solid rgba(212,175,55,0.15); color: var(--gold); padding: 10px 20px; border-radius: 999px; cursor:pointer; }
        #loadMore[disabled] { opacity: 0.45; cursor: default; transform: none; }
    </style>
</head>
<body>

    <header>
        <h1>ALANKAR EVENTS</h1>
        <p>A Legacy of Luxury</p>
    </header>

    <div id="gallery" aria-live="polite"></div>
    <div id="loadMoreWrap"><button id="loadMore">Load more</button></div>

    <div id="photoModal" role="dialog" aria-modal="true" aria-hidden="true">
        <div class="modal-container">
            <span id="modalClose" onclick="closeModal()" role="button" aria-label="Close modal" style="position:absolute; top:12px; right:12px; color:var(--gold); font-size:36px; cursor:pointer;">&times;</span>
            <div class="modal-loader" id="modalLoader"><div class="spinner" aria-hidden="true"></div><div id="modalLoaderText">Loading…</div></div>
            <img class="modal-content" id="modalImg" alt="Enlarged photo" style="display:none;">
            <br>
            <a id="waLink" href="#" target="_blank" class="wa-btn" style="display:none">Inquire on WhatsApp</a>
        </div>
    </div>

    <div id="adminPanel">
        <div class="admin-card">
            <h2 style="text-align:center; color:var(--gold)">Admin Studio</h2>
            <input type="file" id="photoInput" accept="image/*">
            <input type="text" id="priceInput" placeholder="Price (e.g. ₹80,000)">
            <select id="categorySelect" title="Select category">
                <option value="Marriage" selected>Marriage</option>
                <option value="Birthday">Birthday</option>
                <option value="Babyshower">Babyshower</option>
                <option value="Other">Other</option>
            </select>
            <button class="btn-post" onclick="handleUpload()">Post to Gallery</button>
            <p id="status" style="font-size:12px; color:var(--gold); text-align:center;"></p>
        </div>
    </div>

    <footer onclick="secretClick()">© ALANKAR EVENTS</footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, getDocs, limit, startAfter, deleteDoc, doc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js[...]

        const firebaseConfig = {
            apiKey: "AIzaSyDCBOg_FlIpVZyBYVW6yFUcgU7gwIUD1Ks",
            authDomain: "alankar-luxe.firebaseapp.com",
            projectId: "alankar-luxe",
            messagingSenderId: "1093775711292",
            appId: "1:1093775711292:web:30ffd3741a16c10ce9b739"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Perf-tuned constants
        const PAGE_SIZE = 9;               // smaller page for faster initial paint
        const THUMB_TARGET_KB = 18;        // small thumbnail for gallery
        const THUMB_MAX_WIDTH = 420;
        const FULL_TARGET_KB = 50;         // full image for modal
        const FULL_MAX_WIDTH = 900;        // allow slightly larger modal for good look
        const MIN_QUALITY = 0.45;

        let isAdmin = false;
        let clickCount = 0;
        let lastVisible = null;
        const idle = window.requestIdleCallback ? window.requestIdleCallback.bind(window) : (cb) => setTimeout(cb, 500);

        // Secret admin toggle
        window.secretClick = () => {
            clickCount++;
            if (clickCount === 5) {
                const pass = prompt("Key:");
                if (pass === "alankar777") {
                    isAdmin = true;
                    document.getElementById('adminPanel').style.display = 'block';
                    document.getElementById('adminPanel').scrollIntoView({behavior: 'smooth'});
                    // refresh current view
                    resetAndLoad();
                }
                clickCount = 0;
            }
            setTimeout(() => { clickCount = 0; }, 3000);
        };

        // Helpers
        function dataUrlSizeKB(dataUrl) {
            if (!dataUrl) return 0;
            const comma = dataUrl.indexOf(',');
            const b64 = dataUrl.slice(comma + 1);
            const padding = (b64.endsWith('==') ? 2 : b64.endsWith('=') ? 1 : 0);
            const bytes = (b64.length * 3) / 4 - padding;
            return bytes / 1024;
        }

        function compressDataUrlToTarget(dataUrl, targetKB = FULL_TARGET_KB, maxWidth = FULL_MAX_WIDTH) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.src = dataUrl;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const scale = Math.min(1, maxWidth / img.width);
                    canvas.width = Math.round(img.width * scale);
                    canvas.height = Math.round(img.height * scale);
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    let quality = 0.92;
                    const tryExport = () => {
                        const out = canvas.toDataURL('image/jpeg', quality);
                        if (dataUrlSizeKB(out) <= targetKB || quality <= MIN_QUALITY) {
                            resolve(out);
                        } else {
                            quality -= 0.06;
                            if (quality < MIN_QUALITY) quality = MIN_QUALITY;
                            setTimeout(tryExport, 0);
                        }
                    };
                    tryExport();
                };
                img.onerror = reject;
            });
        }

        function compressFileToTarget(file, targetKB = FULL_TARGET_KB, maxWidth = FULL_MAX_WIDTH) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const scale = Math.min(1, maxWidth / img.width);
                        canvas.width = Math.round(img.width * scale);
                        canvas.height = Math.round(img.height * scale);
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        let quality = 0.92;
                        const tryExport = () => {
                            const dataUrl = canvas.toDataURL('image/jpeg', quality);
                            if (dataUrlSizeKB(dataUrl) <= targetKB || quality <= MIN_QUALITY) {
                                resolve(dataUrl);
                            } else {
                                quality -= 0.06;
                                if (quality < MIN_QUALITY) quality = MIN_QUALITY;
                                setTimeout(tryExport, 0);
                            }
                        };
                        tryExport();
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        }

        // Upload handler: create both thumbnail and full image, store both in Firestore
        window.handleUpload = async () => {
            const input = document.getElementById('photoInput');
            const price = document.getElementById('priceInput');
            const categorySelect = document.getElementById('categorySelect');
            if (!input.files[0]) return;
            document.getElementById('status').innerText = "COMPRESSING & UPLOADING...";
            try {
                const file = input.files[0];
                // create thumbnail and full image (in parallel)
                const [thumb, full] = await Promise.all([
                    compressFileToTarget(file, THUMB_TARGET_KB, THUMB_MAX_WIDTH),
                    compressFileToTarget(file, FULL_TARGET_KB, FULL_MAX_WIDTH)
                ]);
                await addDoc(collection(db, "event_photos"), {
                    thumb,
                    imageText: full,
                    price: price.value || "Request Quote",
                    category: categorySelect.value || "Marriage",
                    timestamp: new Date()
                });
                document.getElementById('status').innerText = "DONE.";
                // refresh view to show newest item (fast)
                resetAndLoad();
            } catch (err) {
                console.error("Upload error:", err);
                document.getElementById('status').innerText = "ERROR.";
            } finally {
                input.value = ""; price.value = ""; categorySelect.value = "Marriage";
                setTimeout(()=> document.getElementById('status').innerText = "", 2000);
            }
        };

        window.deleteItem = async (e, id) => {
            e.stopPropagation(); // stop modal from opening when clicking delete
            if (confirm("Permanently delete this?")) {
                try {
                    await deleteDoc(doc(db, "event_photos", id));
                    // refresh current view
                    resetAndLoad();
                } catch (err) {
                    console.error("Delete failed:", err);
                }
            }
        };

        // update fields (used by edit)
        async function updateItemFields(e, id, fields, panel) {
            e.stopPropagation();
            try {
                panel.querySelector('.save-btn').disabled = true;
                await updateDoc(doc(db, "event_photos", id), fields);
                panel.querySelector('.save-btn').innerText = "Saved";
                setTimeout(()=> resetAndLoad(), 700);
            } catch (err) {
                console.error("Update failed", err);
                panel.querySelector('.save-btn').innerText = "Error";
                panel.querySelector('.save-btn').disabled = false;
            }
        }

        // Modal handling: load full image on demand (fetch from doc if we avoided keeping large data in DOM)
        async function openModal(card) {
            const imgEl = document.getElementById('modalImg');
            const loader = document.getElementById('modalLoader');
            const wa = document.getElementById('waLink');
            const waText = document.getElementById('modalLoaderText');
            loader.style.display = 'flex';
            imgEl.style.display = 'none';
            wa.style.display = 'none';
            document.getElementById('photoModal').classList.add('active');
            document.getElementById('photoModal').setAttribute('aria-hidden', 'false');

            // If this card already has cached _full, use it
            if (card._full) {
                imgEl.src = card._full;
                imgEl.onload = () => {
                    loader.style.display = 'none';
                    imgEl.style.display = 'block';
                };
                const msg = encodeURIComponent(`Hi Alankar Events, I'm interested in this setup. Category: ${card._category}. Price: ${card._price}`);
                wa.href = `https://wa.me/916361755076?text=${msg}`;
                wa.style.display = 'inline-block';
                return;
            }

            // otherwise fetch the full from Firestore doc (keeps memory low)
            try {
                const remote = await getDoc(doc(db, "event_photos", card._id));
                const data = remote.data() || {};
                const fullSrc = data.imageText;
                card._full = fullSrc; // cache for quick re-open
                card._category = data.category || card._category;
                card._price = data.price || card._price;

                // attempt to decode image and display
                const pre = new Image();
                pre.src = fullSrc;
                pre.onload = () => {
                    imgEl.src = fullSrc;
                    const msg = encodeURIComponent(`Hi Alankar Events, I'm interested in this setup. Category: ${card._category}. Price: ${card._price}`);
                    wa.href = `https://wa.me/916361755076?text=${msg}`;
                    loader.style.display = 'none';
                    imgEl.style.display = 'block';
                    wa.style.display = 'inline-block';
                };
                pre.onerror = () => {
                    imgEl.src = fullSrc;
                    loader.style.display = 'none';
                    imgEl.style.display = 'block';
                    wa.style.display = 'inline-block';
                };
            } catch (err) {
                console.error("Failed to fetch full image", err);
                loader.style.display = 'none';
                wa.style.display = 'none';
            }
        }

        function closeModal() {
            document.getElementById('photoModal').classList.remove('active');
            document.getElementById('photoModal').setAttribute('aria-hidden', 'true');
            document.getElementById('modalImg').src = '';
            document.getElementById('waLink').style.display = 'none';
        }

        // Allow Escape key to close modal and clicking backdrop to close
        document.addEventListener('keydown', (e) => {
            const modal = document.getElementById('photoModal');
            if (modal && modal.classList.contains('active') && (e.key === 'Escape' || e.key === 'Esc')) {
                closeModal();
            }
        });

        document.getElementById('photoModal').addEventListener('click', (e) => {
            // only close when clicking the backdrop (not when clicking inside the modal container)
            if (e.target === e.currentTarget) {
                closeModal();
            }
        });

        // Lazy-loading using IntersectionObserver for thumbs
        const io = ('IntersectionObserver' in window) ? new IntersectionObserver((entries, obs) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    const src = img.dataset.src;
                    if (src) {
                        // progressive reveal: set a very small timeout to avoid jank on scroll
                        requestAnimationFrame(() => {
                            img.src = src;
                            img.removeAttribute('data-src');
                            img.decode?.().catch(()=>{});
                        });
                    }
                    obs.unobserve(img);
                }
            });
        }, { rootMargin: '300px' }) : null;

        // Render + Pagination using getDocs (fast initial paint, less realtime overhead)
        const galleryEl = document.getElementById('gallery');
        const loadMoreBtn = document.getElementById('loadMore');
        loadMoreBtn.addEventListener('click', () => loadPage());

        // show skeleton placeholders to improve perceived performance
        function showSkeleton(count = PAGE_SIZE) {
            galleryEl.innerHTML = '';
            const frag = document.createDocumentFragment();
            for (let i = 0; i < count; i++) {
                const s = document.createElement('div');
                s.className = 'skeleton-card';
                const anim = document.createElement('div');
                anim.className = 'skeleton-anim';
                s.appendChild(anim);
                frag.appendChild(s);
            }
            galleryEl.appendChild(frag);
        }

        async function resetAndLoad() {
            lastVisible = null;
            showSkeleton(6); // show a small number quickly
            document.getElementById('loadMoreWrap').style.display = 'block';
            await loadPage(true);
        }

        async function loadPage(initial = false) {
            // Prevent double clicks quickly
            if (loadMoreBtn.disabled) return;
            loadMoreBtn.disabled = true;
            const prevText = loadMoreBtn.innerText;
            loadMoreBtn.innerText = "Loading...";
            try {
                let q;
                const col = collection(db, "event_photos");
                if (!lastVisible) {
                    q = query(col, orderBy("timestamp", "desc"), limit(PAGE_SIZE));
                } else {
                    q = query(col, orderBy("timestamp", "desc"), startAfter(lastVisible), limit(PAGE_SIZE));
                }
                const snap = await getDocs(q);
                if (snap.empty && !lastVisible) {
                    // no items
                    galleryEl.innerHTML = '<p style="text-align:center; color:var(--gold);">No photos yet.</p>';
                    document.getElementById('loadMoreWrap').style.display = 'none';
                    return;
                }

                // append results (use DocumentFragment for minimal reflow)
                const frag = document.createDocumentFragment();

                for (const fbDoc of snap.docs) {
                    const d = fbDoc.data() || {};
                    if (!d.category) d.category = "Marriage";

                    // card
                    const card = document.createElement('div');
                    card.className = "item-card";

                    // store id & metadata on card (avoid storing large full image unless small)
                    card._id = fbDoc.id;
                    card._category = d.category || "Marriage";
                    card._price = d.price || "Request Quote";

                    // Decide whether to keep the full string in memory: only if small enough
                    try {
                        const sizeKB = dataUrlSizeKB(d.imageText || "");
                        if ((sizeKB > 0 && sizeKB <= FULL_TARGET_KB + 6)) {
                            card._full = d.imageText;
                        } else {
                            card._full = null;
                        }
                    } catch (err) {
                        card._full = null;
                    }

                    // click opens modal (we pass the card object)
                    card.onclick = () => openModal(card);

                    // image wrapper
                    const wrapper = document.createElement('div');
                    wrapper.className = 'img-wrapper';

                    // image element uses lazy loading + IO
                    const img = document.createElement('img');
                    img.alt = d.category || "Photo";
                    img.loading = 'lazy';
                    img.dataset.src = d.thumb || d.imageText || '';
                    img.style.opacity = '0';
                    img.addEventListener('load', () => { img.style.transition = 'opacity .18s'; img.style.opacity = '1'; });

                    wrapper.appendChild(img);
                    card.appendChild(wrapper);

                    // If thumb missing, schedule a background thumbnail creation (deferred)
                    if (!d.thumb && d.imageText) {
                        idle(async () => {
                            try {
                                const small = await compressDataUrlToTarget(d.imageText, THUMB_TARGET_KB, THUMB_MAX_WIDTH);
                                await updateDoc(doc(db, "event_photos", fbDoc.id), { thumb: small });
                            } catch (err) {
                                // ignore failures (security rules or other)
                                console.warn("Failed to create thumb", fbDoc.id, err);
                            }
                        });
                    }

                    // admin controls
                    if (isAdmin) {
                        const delBtn = document.createElement('button');
                        delBtn.className = 'del-btn';
                        delBtn.innerText = 'REMOVE';
                        delBtn.onclick = (e) => deleteItem(e, fbDoc.id);
                        card.appendChild(delBtn);

                        const editBtn = document.createElement('button');
                        editBtn.className = 'edit-btn';
                        editBtn.innerText = 'EDIT';
                        editBtn.onclick = (e) => {
                            e.stopPropagation();
                            // toggle edit panel
                            const existing = card.querySelector('.edit-panel');
                            if (existing) {
                                existing.remove();
                                return;
                            }
                            const panel = document.createElement('div');
                            panel.className = 'edit-panel';
                            const priceInput = document.createElement('input');
                            priceInput.value = d.price || '';
                            priceInput.placeholder = 'Price';
                            const catSelect = document.createElement('select');
                            ['Marriage','Birthday','Babyshower','Other'].forEach(v => {
                                const o = document.createElement('option');
                                o.value = v; o.innerText = v;
                                if (v === (d.category || 'Marriage')) o.selected = true;
                                catSelect.appendChild(o);
                            });
                            const saveBtn = document.createElement('button');
                            saveBtn.className = 'save-btn';
                            saveBtn.innerText = 'Save';
                            saveBtn.onclick = (ev) => updateItemFields(ev, fbDoc.id, { price: priceInput.value || 'Request Quote', category: catSelect.value || 'Other' }, panel);
                            const cancelBtn = document.createElement('button');
                            cancelBtn.className = 'cancel-btn';
                            cancelBtn.innerText = 'Cancel';
                            cancelBtn.onclick = (ev) => { ev.stopPropagation(); panel.remove(); };

                            panel.appendChild(priceInput);
                            panel.appendChild(catSelect);
                            panel.appendChild(saveBtn);
                            panel.appendChild(cancelBtn);
                            card.appendChild(panel);
                        };
                        card.appendChild(editBtn);
                    }

                    // badge + price
                    const badge = document.createElement('div');
                    badge.className = 'category-badge';
                    badge.innerText = d.category || "Marriage";

                    const priceTag = document.createElement('div');
                    priceTag.className = 'price-tag';
                    priceTag.innerText = d.price || "Request Quote";

                    card.appendChild(badge);
                    card.appendChild(priceTag);

                    frag.appendChild(card);

                    // Observe image for lazy load
                    if (io && img.dataset.src) io.observe(img);
                    else if (img.dataset.src) {
                        img.src = img.dataset.src;
                        img.decode?.().catch(()=>{});
                    }
                }

                // If this is the first page, replace skeletons; otherwise append
                if (!lastVisible) {
                    galleryEl.innerHTML = '';
                }
                galleryEl.appendChild(frag);

                // update lastVisible for pagination
                if (snap.docs.length > 0) {
                    lastVisible = snap.docs[snap.docs.length - 1];
                }

                // if we received less than a full page, hide load more
                if (snap.docs.length < PAGE_SIZE) {
                    document.getElementById('loadMoreWrap').style.display = 'none';
                } else {
                    document.getElementById('loadMoreWrap').style.display = 'block';
                }

            } catch (err) {
                console.error("Failed to load page", err);
            } finally {
                loadMoreBtn.disabled = false;
                loadMoreBtn.innerText = prevText || "Load more";
            }
        }

        // initial load
        resetAndLoad();
    </script>
</body>
</html>
